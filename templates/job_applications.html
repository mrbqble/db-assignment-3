{% extends "base.html" %} {% block title %}Job Applications - Database Management{% endblock %} {% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="margin: 0; color: #495057">Job Applications</h2>
    <a href="{{ url_for('create_job_application') }}" class="btn btn-create" style="padding: 10px 20px; text-decoration: none;">Create Job Application</a>
</div>

<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
	<form method="GET" action="{{ url_for('job_applications') }}" id="filterForm" style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
		<div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
			<label for="caregiving_type" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Required Caregiving Type</label>
			<select id="caregiving_type" name="caregiving_type" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
				<option value="">All Types</option>
				{% for type in caregiving_types %}
				<option value="{{ type }}" {% if selected_caregiving_type == type %}selected{% endif %}>{{ type }}</option>
				{% endfor %}
			</select>
		</div>
		<div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
			<label for="caregiver_id" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Caregiver</label>
			<select id="caregiver_id" name="caregiver_id" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
				<option value="">All Caregivers</option>
				{% for id, name in caregiver_ids %}
				<option value="{{ id }}" {% if caregiver_id and caregiver_id|int == id %}selected{% endif %}>{{ id }} - {{ name }}</option>
				{% endfor %}
			</select>
		</div>
		<div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
			<label for="member_id" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Member</label>
			<select id="member_id" name="member_id" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
				<option value="">All Members</option>
				{% for id, name in member_ids %}
				<option value="{{ id }}" {% if member_id and member_id|int == id %}selected{% endif %}>{{ id }} - {{ name }}</option>
				{% endfor %}
			</select>
		</div>
		<div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
			<label for="job_id" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Job ID</label>
			<select id="job_id" name="job_id" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
				<option value="">All Jobs</option>
				{% for id in job_ids %}
				<option value="{{ id }}" {% if job_id and job_id|int == id %}selected{% endif %}>{{ id }}</option>
				{% endfor %}
			</select>
		</div>
		<div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
			<label for="from_date" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">From Date</label>
			<select id="from_date" name="from_date" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
				<option value="">All Dates</option>
				{% for date_val in available_dates %}
				<option value="{{ date_val.isoformat() }}" {% if from_date == date_val.isoformat() %}selected{% endif %}>{{ date_val.strftime('%d/%m/%Y') }}</option>
				{% endfor %}
			</select>
		</div>
		<div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
			<label for="to_date" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">To Date</label>
			<select id="to_date" name="to_date" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
				<option value="">All Dates</option>
				{% for date_val in available_dates %}
				<option value="{{ date_val.isoformat() }}" data-date="{{ date_val.isoformat() }}" {% if to_date == date_val.isoformat() %}selected{% endif %}>{{ date_val.strftime('%d/%m/%Y') }}</option>
				{% endfor %}
			</select>
		</div>
		<div style="display: flex; gap: 10px;">
			<a href="{{ url_for('job_applications') }}" class="btn btn-cancel" style="padding: 8px 20px; text-decoration: none;">Clear</a>
		</div>
	</form>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		const caregivingTypeSelect = document.getElementById('caregiving_type');
		const caregiverIdSelect = document.getElementById('caregiver_id');
		const memberIdSelect = document.getElementById('member_id');
		const jobIdSelect = document.getElementById('job_id');
		const fromDateSelect = document.getElementById('from_date');
		const toDateSelect = document.getElementById('to_date');
		const filterForm = document.getElementById('filterForm');

		// Function to filter to_date options based on from_date
		function filterToDateOptions() {
			const fromDateValue = fromDateSelect.value;
			const toDateOptions = toDateSelect.querySelectorAll('option');
			const currentToDateValue = toDateSelect.value;

			// Show/hide options based on from_date
			toDateOptions.forEach(function(option) {
				if (option.value === '') {
					// Always show "All Dates" option
					option.style.display = '';
				} else if (fromDateValue === '') {
					// If no from_date selected, show all dates
					option.style.display = '';
				} else {
					// Only show dates >= from_date
					const optionDate = option.getAttribute('data-date');
					if (optionDate && optionDate >= fromDateValue) {
						option.style.display = '';
					} else {
						option.style.display = 'none';
					}
				}
			});

			// If current to_date is invalid (less than from_date), clear it
			if (fromDateValue && currentToDateValue) {
				if (currentToDateValue < fromDateValue) {
					toDateSelect.value = '';
				}
			}
		}

		// Initial filter on page load
		filterToDateOptions();

		caregivingTypeSelect.addEventListener('change', function() {
			filterForm.submit();
		});

		caregiverIdSelect.addEventListener('change', function() {
			filterForm.submit();
		});

		memberIdSelect.addEventListener('change', function() {
			filterForm.submit();
		});

		jobIdSelect.addEventListener('change', function() {
			filterForm.submit();
		});

		fromDateSelect.addEventListener('change', function() {
			filterToDateOptions();
			filterForm.submit();
		});

		toDateSelect.addEventListener('change', function() {
			filterForm.submit();
		});
	});
</script>

{% if job_applications %}
<table>
	<thead>
		<tr>
			<th>Caregiver ID</th>
			<th>Caregiver Name</th>
			<th>Member ID</th>
			<th>Member Name</th>
			<th>Job ID</th>
			<th>Required Caregiving Type</th>
			<th>Date Applied</th>
			<th>Actions</th>
		</tr>
	</thead>
	<tbody>
		{% for app in job_applications %}
		<tr>
			<td>{{ app.caregiver_user_id }}</td>
			<td><strong>{{ app.caregiver.user.given_name }} {{ app.caregiver.user.surname }}</strong></td>
			<td>{{ app.job.member.member_user_id }}</td>
			<td>{{ app.job.member.user.given_name }} {{ app.job.member.user.surname }}</td>
			<td>{{ app.job_id }}</td>
			<td><span class="badge badge-info">{{ app.job.required_caregiving_type }}</span></td>
			<td>{{ app.date_applied.strftime('%d/%m/%Y') if app.date_applied else '-' }}</td>
			<td>
				<div class="action-buttons">
					<form
						method="POST"
						action="{{ url_for('delete_job_application', caregiver_id=app.caregiver_user_id, job_id=app.job_id) }}"
						style="display: inline"
						onsubmit="return confirm('Are you sure you want to delete this job application?');"
					>
						<button
							type="submit"
							class="btn btn-delete"
						>
							Delete
						</button>
					</form>
				</div>
			</td>
		</tr>
		{% endfor %}
	</tbody>
</table>
{% else %}
<div class="empty-state">
	<h3>No job applications found</h3>
	<p>The database is empty.</p>
</div>
{% endif %} {% endblock %}
